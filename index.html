<!DOCTYPE html>
<html>
<head>
	<title>Elm image annotation demo</title>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>html, body, .style-elements { height: 100% }</style>
	<script src="Main.js"></script>
	<script src="elm-pep.js"></script>
</head>
<body>
	<script charset="utf-8">
		const layoutViewportSize = () => ({
			width: document.documentElement.clientWidth,
			height: document.documentElement.clientHeight
		})
		const app = Elm.Main.fullscreen( layoutViewportSize() )
		
		window.addEventListener( 'resize', () => app.ports.resizes.send( layoutViewportSize() ) )
		
		app.ports.loadImageFile.subscribe( pair => {
			const id = pair[0]
			const file = pair[1]
			if ( file.type.match( /image.*/ ) ) {
				sendLoadedImage( id, file, app.ports.imageLoaded )
			}
		})

		function sendLoadedImage( id, imageFile, outPort ) {
			const img = document.createElement( "img" )
			img.onload = () => outPort.send(
				{id: id, url: img.src, width: img.width, height: img.height}
			)
			img.src = window.URL.createObjectURL( imageFile )
		}

		app.ports.loadConfigFile.subscribe( (file) => {
			if ( file.type === "application/json" ) {
				sendLoadedConfig( file, app.ports.configLoaded )
			}
		})

		function sendLoadedConfig( configFile, outPort ) {
			const fileReader = new FileReader()
			fileReader.onload = () => outPort.send( fileReader.result )
			fileReader.readAsText( configFile )
		}
	</script>
</body>
</html>
